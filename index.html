<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wawrzak Board</title>
    
    <!-- --- 1. PO≈ÅƒÑCZENIE Z PLIKIEM MANIFESTU --- -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Ustawienia dla iOS (iPhone) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wawrzak Board">
    <meta name="theme-color" content="#0f172a">
    <!-- Opcjonalnie: ikona dla iOS -->
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Biblioteki zewnƒôtrzne (Tailwind, React, Babel) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- DODANE: Konfiguracja Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* Blokada "gumkowania" strony przy przewijaniu */
        body { 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
        }
        /* Ukrycie paska przewijania dla estetyki */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* DODANE: Animacja dla Toast */
        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .toast-animate {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>
<!-- DODANE: Klasy Dark Mode na body -->
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 select-none transition-colors duration-300">
    <div id="root"></div>

    <!-- --- 2. KOD APLIKACJI --- -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- IKONY (SVG) ---
        const IconWrapper = ({ children, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick} style={{cursor: onClick ? 'pointer' : 'default'}}>
                {children}
            </svg>
        );

        const Icons = {
            PartyPopper: (props) => <IconWrapper {...props}><path d="M5.8 11.3 2 22l10.7-3.79"/><path d="M4 3h.01"/><path d="M22 8h.01"/><path d="M15 2h.01"/><path d="M22 20h.01"/><path d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12v0c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10"/><path d="m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11v0c-.11.7-.72 1.22-1.43 1.22H17"/><path d="m11 2 .33.82c.34.86-.2 1.82-1.11 1.98v0C9.52 4.9 9 5.52 9 6.23V7"/><path d="M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z"/></IconWrapper>,
            UserPlus: (props) => <IconWrapper {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></IconWrapper>,
            Heart: (props) => <IconWrapper {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconWrapper>,
            Users: (props) => <IconWrapper {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>,
            Calendar: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconWrapper>,
            Phone: (props) => <IconWrapper {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconWrapper>,
            Bell: (props) => <IconWrapper {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconWrapper>,
            Edit2: (props) => <IconWrapper {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>,
            Trash2: (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Save: (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            X: (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            // DODANE: Nowe ikony
            Moon: (props) => <IconWrapper {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconWrapper>,
            Sun: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41-1.41"/><path d="m19.07 4.93-1.41-1.41"/></IconWrapper>,
            Settings: (props) => <IconWrapper {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            Download: (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            Check: (props) => <IconWrapper {...props}><polyline points="20 6 9 17 4 12"/></IconWrapper>,
            EyeOff: (props) => <IconWrapper {...props}><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19.5C6.32 19.5 3 12.5 3 12.5a21.77 21.77 0 0 1 5.06-6.44"/><path d="M1 1l22 22"/><path d="M9.88 9.88a3 3 0 0 0 4.24 4.24"/><path d="M12 5.5c5.68 0 9 7 9 7a21.77 21.77 0 0 1-3.2 4.02"/></IconWrapper>
        };
        Icons.Gift = (props) => (
            <IconWrapper {...props}>
                <rect x="3" y="8" width="18" height="13" rx="2"/>
                <path d="M3 8h18"/>
                <path d="M12 8v13"/>
                <path d="M12 8c-1.66 0-3-1.79-3-3.5S10.34 1 12 1s3 1.79 3 3.5S13.66 8 12 8Z"/>
            </IconWrapper>
        );
        Icons.MapPin = (props) => (
            <IconWrapper {...props}>
                <path d="M12 21s8-4.5 8-11a8 8 0 1 0-16 0c0 6.5 8 11 8 11z"/>
                <circle cx="12" cy="10" r="3"/>
            </IconWrapper>
        );

        // --- DODANE: Funkcje pomocnicze do awatar√≥w ---
        const getInitials = (name) => {
            if (!name) return '??';
            return String(name).split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
        };

        const stringToColor = (str) => {
            if (!str) return '#94a3b8';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        };

        // --- DANE STARTOWE ---
        const INITIAL_FAMILY = [
            { id: 1,  name: 'Tomasz Wawrzak',     birthDate: '1965-03-02', phone: '', notes: '', type: 'family' },
            { id: 2,  name: 'Zdzis≈Çaw Koseski',   birthDate: '1955-03-15', phone: '', notes: '', type: 'family' },
            { id: 3,  name: 'El≈ºbieta Wawrzak',   birthDate: '1964-03-17', phone: '', notes: '', type: 'family' },
            { id: 4,  name: '≈Åukasz Wawrzak',     birthDate: '1987-09-23', phone: '', notes: '', type: 'family' },
            { id: 5,  name: 'Kinga Wawrzak',      birthDate: '1988-07-09', phone: '', notes: '', type: 'family' },
            { id: 6,  name: 'Kornelia Wawrzak',   birthDate: '2023-06-19', phone: '', notes: '', type: 'family' },
            { id: 7,  name: 'Micha≈Ç Wawrzak',     birthDate: '1994-06-10', phone: '', notes: '', type: 'family' },
            { id: 8,  name: 'Milena Wawrzak',     birthDate: '1993-06-20', phone: '', notes: '', type: 'family' },
            { id: 9,  name: 'Michalina Wawrzak',  birthDate: '2021-10-23', phone: '', notes: '', type: 'family' },
            { id: 10, name: 'Marcel Wawrzak',     birthDate: '2023-09-17', phone: '', notes: '', type: 'family' },
            { id: 11, name: 'Kamil Wawrzak',      birthDate: '1991-04-21', phone: '', notes: '', type: 'family' },
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyDqNfSnW90aBAvu98nJeqMgJbbWXwVwZf4",
            authDomain: "wawrzak-board.firebaseapp.com",
            projectId: "wawrzak-board",
            storageBucket: "wawrzak-board.firebasestorage.app",
            messagingSenderId: "504386767824",
            appId: "1:504386767824:web:63edc5a12503e9e5c907d5",
            measurementId: "G-78JL4DVGV4"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const DB = firebase.firestore();
        try { DB.enablePersistence(); } catch (e) {}

        const Fire = {
            db: DB,
            collection: (db, name) => db.collection(name),
            doc: (db, col, id) => db.collection(col).doc(String(id)),
            onSnapshot: (ref, cb) => ref.onSnapshot(cb),
            setDoc: (ref, data, options = {}) => options.merge ? ref.set(data, { merge: true }) : ref.set(data),
            deleteDoc: (ref) => ref.delete(),
        };

        const migratePeople = (list) => {
            return (list || []).map(p => ({
                ...p,
                address: typeof p.address === 'string' ? p.address : '',
                wishlist: Array.isArray(p.wishlist) ? p.wishlist.map(item => ({
                    id: item.id ?? Date.now() + Math.random(),
                    name: item.name ?? '',
                    reservedBy: typeof item.reservedBy === 'number' ? item.reservedBy : null,
                })) : [],
            }));
        };

        const syncWithSource = (loaded, source) => {
            const sourceMap = new Map(source.map(s => [s.name, s]));
            const NAME_CORRECTIONS = {
                'Zdzis≈Çaw Kosecki': 'Zdzis≈Çaw Koseski',
                'Zdzis≈Çawa Koseski': 'Zdzis≈Çaw Koseski',
                'Tomasz Pawe≈Ç Wawrzak': 'Tomasz Wawrzak'
            };

            const normalized = (loaded || []).map(p => ({ ...p, name: NAME_CORRECTIONS[p.name] || p.name }));

            const byName = new Map();
            normalized.forEach(p => {
                const ex = byName.get(p.name);
                if (!ex) {
                    byName.set(p.name, { ...p });
                } else {
                    const merged = { ...ex };
                    merged.phone = merged.phone || p.phone || '';
                    merged.notes = merged.notes || p.notes || '';
                    merged.address = merged.address || p.address || '';
                    const a = Array.isArray(merged.wishlist) ? merged.wishlist : [];
                    const b = Array.isArray(p.wishlist) ? p.wishlist : [];
                    const union = [...a];
                    b.forEach(item => { if (!union.some(x => x.id === item.id && x.name === item.name)) union.push(item); });
                    merged.wishlist = union;
                    byName.set(p.name, merged);
                }
            });

            let maxId = 0;
            byName.forEach(p => { if (typeof p.id === 'number' && p.id > maxId) maxId = p.id; });

            const updated = Array.from(byName.values()).map(p => {
                const s = sourceMap.get(p.name);
                const base = { ...p };
                if (s && base.type === 'family') {
                    base.birthDate = s.birthDate;
                    base.type = 'family';
                }
                return base;
            });

            const existingNames = new Set(updated.map(p => p.name));
            source.forEach(s => {
                if (!existingNames.has(s.name)) {
                    maxId += 1;
                    updated.push({
                        id: maxId,
                        name: s.name,
                        birthDate: s.birthDate,
                        phone: '',
                        notes: '',
                        address: '',
                        wishlist: [],
                        type: 'family',
                    });
                }
            });

            return migratePeople(updated);
        };

        function Wishlist({ person, currentUserId, onUpdate, resolveName }) {
            const [newItemName, setNewItemName] = useState('');

            const addItem = () => {
                const name = newItemName.trim();
                if (!name) return;
                const updated = {
                    ...person,
                    wishlist: [...(person.wishlist || []), { id: Date.now(), name, reservedBy: null }]
                };
                onUpdate(updated);
                setNewItemName('');
            };

            const deleteItem = (id) => {
                const updated = {
                    ...person,
                    wishlist: (person.wishlist || []).filter(w => w.id !== id)
                };
                onUpdate(updated);
            };

            const reserveItem = (id) => {
                const updated = {
                    ...person,
                    wishlist: (person.wishlist || []).map(w => w.id === id ? { ...w, reservedBy: currentUserId } : w)
                };
                onUpdate(updated);
            };

            const isSelf = currentUserId === person.id;

            return (
                <div className="space-y-3">
                    <div className="flex items-center gap-2">
                        <Icons.Gift className="text-amber-500 dark:text-amber-400" size={18} />
                        <h4 className="text-sm font-bold uppercase tracking-wide text-slate-700 dark:text-slate-300">Lista ≈ªycze≈Ñ</h4>
                    </div>
                    {isSelf ? (
                        <div className="space-y-3">
                            <div className="flex gap-2">
                                <input type="text" value={newItemName} onChange={e => setNewItemName(e.target.value)} className="flex-1 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-amber-400 outline-none text-sm text-slate-800 dark:text-slate-100" placeholder="Dodaj ≈ºyczenie (np. ksiƒÖ≈ºka)" />
                                <button onClick={addItem} className="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide">Dodaj</button>
                            </div>
                            <ul className="space-y-2">
                                {(person.wishlist || []).length === 0 ? (
                                    <li className="text-xs text-slate-400">Brak element√≥w na li≈õcie.</li>
                                ) : (
                                    (person.wishlist || []).map(item => (
                                        <li key={item.id} className="flex items-center justify-between bg-slate-50 dark:bg-slate-700 px-3 py-2 rounded-md border border-slate-200 dark:border-slate-600">
                                            <span className="text-sm text-slate-800 dark:text-slate-200">{item.name}</span>
                                            <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700 text-xs font-bold uppercase tracking-wide">Usu≈Ñ</button>
                                        </li>
                                    ))
                                )}
                            </ul>
                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                <Icons.EyeOff size={14} />
                                <span>Nie zobaczysz rezerwacji swoich ≈ºycze≈Ñ.</span>
                            </div>
                        </div>
                    ) : (
                        <ul className="space-y-2">
                            {(person.wishlist || []).length === 0 ? (
                                <li className="text-xs text-slate-400">Brak ≈ºycze≈Ñ do zarezerwowania.</li>
                            ) : (
                                (person.wishlist || []).map(item => (
                                    <li key={item.id} className="flex items-center justify-between bg-slate-50 dark:bg-slate-700 px-3 py-2 rounded-md border border-slate-200 dark:border-slate-600">
                                        <span className={`text-sm ${item.reservedBy ? 'line-through text-slate-400' : 'text-slate-800 dark:text-slate-200'}`}>{item.name}</span>
                                        {item.reservedBy ? (
                                            <div className="flex items-center gap-2 text-green-600 text-xs">
                                                <Icons.Check size={14} />
                                                <span>Zarezerwowane przez {resolveName(item.reservedBy)}</span>
                                            </div>
                                        ) : (
                                            <button onClick={() => reserveItem(item.id)} className="bg-amber-400 hover:bg-amber-500 text-slate-900 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wide">Rezerwuj</button>
                                        )}
                                    </li>
                                ))
                            )}
                        </ul>
                    )}
                </div>
            );
        }

        function WawrzakBoard() {
            const [people, setPeople] = useState([]);
            const [activeTab, setActiveTab] = useState('family');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingPerson, setEditingPerson] = useState(null);
            const [formData, setFormData] = useState({ name: '', birthDate: '', phone: '', address: '', notes: '', reminderDays: 3, type: 'family' });
            const [currentUserId, setCurrentUserId] = useState(() => {
                const saved = localStorage.getItem('wawrzakCurrentUserId');
                return saved ? Number(saved) : null;
            });
            const [isDetailsOpen, setIsDetailsOpen] = useState(false);
            const [selectedPerson, setSelectedPerson] = useState(null);
            const [isUserPickerOpen, setIsUserPickerOpen] = useState(false);
            
            // --- DODANE: Stany dla nowych funkcji ---
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('wawrzakDarkMode') === 'true');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isCalendarModalOpen, setIsCalendarModalOpen] = useState(false);
            const [calendarPerson, setCalendarPerson] = useState(null);
            const [daysBeforeBirthday, setDaysBeforeBirthday] = useState(7);
            const [toast, setToast] = useState({ visible: false, message: '', type: 'success' });

            // --- DODANE: Efekt Dark Mode ---
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('wawrzakDarkMode', darkMode);
            }, [darkMode]);

            const showToast = (message, type = 'success') => {
                setToast({ visible: true, message, type });
                setTimeout(() => {
                    setToast({ ...toast, visible: false });
                }, 3000);
            };

            useEffect(() => {
                if (!Fire) return;
                const colRef = Fire.collection(Fire.db, 'people');
                let initial = true;
                const unsub = Fire.onSnapshot(colRef, async (snapshot) => {
                    const loaded = snapshot.docs.map(d => {
                        const data = d.data();
                        const id = typeof data.id === 'number' ? data.id : Number(d.id);
                        return { ...data, id };
                    });
                    const synced = syncWithSource(loaded, INITIAL_FAMILY);
                    setPeople(synced);

                    const loadedById = new Map(loaded.map(p => [p.id, p]));
                    const syncedIds = new Set(synced.map(p => p.id));
                    const snapshotIds = new Set(snapshot.docs.map(d => {
                        const data = d.data();
                        return typeof data.id === 'number' ? data.id : Number(d.id);
                    }));

                    for (const p of synced) {
                        const lp = loadedById.get(p.id);
                        const needUpdate = !lp || lp.name !== p.name || lp.birthDate !== p.birthDate || lp.type !== p.type;
                        if (needUpdate) {
                            await Fire.setDoc(Fire.doc(Fire.db, 'people', String(p.id)), p, { merge: true });
                        }
                    }

                    for (const d of snapshot.docs) {
                        const data = d.data();
                        const id = typeof data.id === 'number' ? data.id : Number(d.id);
                        if (!syncedIds.has(id)) {
                            await Fire.deleteDoc(Fire.doc(Fire.db, 'people', d.id));
                        }
                    }

                    if (initial && snapshot.empty) {
                        for (const p of INITIAL_FAMILY) {
                            await Fire.setDoc(Fire.doc(Fire.db, 'people', String(p.id)), p);
                        }
                    }
                    initial = false;
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (currentUserId != null) {
                    localStorage.setItem('wawrzakCurrentUserId', String(currentUserId));
                }
            }, [currentUserId]);

            const getPersonNameById = (id) => {
                const p = people.find(x => x.id === id);
                return p ? p.name : 'Nieznany';
            };

            const updatePerson = (updatedPerson) => {
                if (!Fire) return;
                Fire.setDoc(Fire.doc(Fire.db, 'people', String(updatedPerson.id)), updatedPerson, { merge: true });
            };

            const openModal = (person = null) => {
                if (person) {
                    setEditingPerson(person);
                    setFormData({ name: person.name, birthDate: person.birthDate, phone: person.phone, address: person.address || '', notes: person.notes, reminderDays: 3, type: person.type });
                } else {
                    setEditingPerson(null);
                    setFormData({ name: '', birthDate: '', phone: '', address: '', notes: '', reminderDays: 3, type: activeTab });
                }
                setIsModalOpen(true);
            };

            const handleSave = async () => {
                if (!formData.name) return alert('Podaj imiƒô i nazwisko!');
                if (editingPerson) {
                    await Fire.setDoc(Fire.doc(Fire.db, 'people', String(editingPerson.id)), { ...editingPerson, ...formData }, { merge: true });
                } else {
                    const newPerson = { ...formData, id: Date.now(), address: formData.address || '', wishlist: [] };
                    await Fire.setDoc(Fire.doc(Fire.db, 'people', String(newPerson.id)), newPerson);
                }
                setIsModalOpen(false);
                showToast('Zapisano pomy≈õlnie!');
            };

            const handleDelete = async (id) => {
                if (window.confirm('Czy na pewno chcesz usunƒÖƒá tƒô osobƒô?')) {
                    await Fire.deleteDoc(Fire.doc(Fire.db, 'people', String(id)));
                    showToast('Usuniƒôto osobƒô', 'error');
                }
            };

            // --- DODANE: Eksport ---
            const handleExportData = () => {
                const dataStr = JSON.stringify(people, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'wawrzak_backup_' + new Date().toISOString().slice(0,10) + '.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showToast('Pobrano kopiƒô zapasowƒÖ!');
            };

            // --- DODANE: Logika Kalendarza (Modal) ---
            const openCalendarModal = (person) => {
                if (!person.birthDate) return alert('Ta osoba nie ma ustawionej daty urodzenia!');
                setCalendarPerson(person);
                setDaysBeforeBirthday(7); 
                setIsCalendarModalOpen(true);
            };

            const generateCalendarLink = (person, daysOffset) => {
                const today = new Date();
                const birthDate = new Date(person.birthDate);
                let nextBday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                if (nextBday < today) {
                    nextBday.setFullYear(today.getFullYear() + 1);
                }
                const reminderDate = new Date(nextBday);
                reminderDate.setDate(nextBday.getDate() - daysOffset);

                const formatGTime = (date) => {
                    return date.toISOString().replace(/-|:|\.\d\d\d/g, "");
                };

                const start = formatGTime(reminderDate);
                const end = formatGTime(new Date(reminderDate.getTime() + (60 * 60 * 1000))); 

                const text = encodeURIComponent(`üéÇ PRZYPOMNIENIE: Urodziny ${person.name} (za ${daysOffset} dni)`);
                const details = encodeURIComponent(
                    `Pamiƒôtaj o nadchodzƒÖcych urodzinach!\n\n` +
                    `üë§ Kto: ${person.name}\n` +
                    `üìÖ Data Urodzin: ${nextBday.toLocaleDateString('pl-PL')}\n` +
                    `üìû Tel: ${person.phone || 'brak'}\n` +
                    `üìç Adres: ${person.address || 'brak'}\n` +
                    `üìù Notatki: ${person.notes || 'brak'}\n\n` +
                    `‚ö†Ô∏è WA≈ªNE: Pamiƒôtaj ustawiƒá alarm/powiadomienie w tym wydarzeniu!`
                );
                
                const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
                return url;
            };

            const calculateAge = (birthDate) => {
                if (!birthDate) return '';
                const diff = Date.now() - new Date(birthDate).getTime();
                return Math.abs(new Date(diff).getUTCFullYear() - 1970);
            };

            const getDaysUntilBirthday = (birthDateString) => {
                if (!birthDateString) return Number.POSITIVE_INFINITY;
                const today = new Date();
                today.setHours(0,0,0,0);
                const parts = birthDateString.split('-').map(Number);
                const year = today.getFullYear();
                const month = parts[1];
                const day = parts[2];
                if (!month || !day) return Number.POSITIVE_INFINITY;
                let next = new Date(year, month - 1, day);
                next.setHours(0,0,0,0);
                if (next < today) {
                    next = new Date(year + 1, month - 1, day);
                    next.setHours(0,0,0,0);
                }
                const diffMs = next.getTime() - today.getTime();
                return Math.round(diffMs / (1000 * 60 * 60 * 24));
            };

            const displayList = people
                .filter(p => p.type === activeTab)
                .map(p => ({ ...p, __days: getDaysUntilBirthday(p.birthDate) }))
                .sort((a, b) => a.__days - b.__days);

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 font-sans text-slate-800 dark:text-slate-100 pb-20 transition-colors duration-300">
                    <header className="bg-gradient-to-b from-slate-900 to-slate-800 text-white shadow-xl rounded-b-3xl pt-8 pb-6 px-4 sticky top-0 z-10 select-none">
                        <div className="container mx-auto flex flex-col items-center text-center">
                            <div className="flex flex-col items-center gap-3 mb-6 transform transition hover:scale-105 duration-300">
                                <div className="bg-gradient-to-br from-amber-300 to-amber-500 p-3 rounded-2xl shadow-lg shadow-amber-500/20">
                                    <Icons.PartyPopper className="w-10 h-10 text-slate-900" />
                                </div>
                                <div>
                                    <h1 className="text-3xl md:text-4xl font-bold tracking-wide font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-amber-500">Wawrzak Board</h1>
                                    <p className="text-slate-400 text-xs uppercase tracking-widest mt-1 font-medium">Centrum ZarzƒÖdzania RodzinƒÖ</p>
                                </div>
                            </div>
                            <button onClick={() => openModal()} className="bg-emerald-500 hover:bg-emerald-600 active:scale-95 text-white px-8 py-3 rounded-full shadow-lg shadow-emerald-500/30 transition-all flex items-center gap-2 font-bold text-sm uppercase tracking-wide">
                                <Icons.UserPlus size={20} /> Dodaj Osobƒô
                            </button>
                            
                            {/* DODANE: Przyciski w nag≈Ç√≥wku */}
                            <div className="mt-4 flex gap-2 w-full max-w-md justify-center">
                                <button onClick={() => setIsUserPickerOpen(true)} className="flex-1 bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-full text-xs font-bold uppercase tracking-wide flex items-center justify-center gap-2">
                                    <Icons.Users size={16} /> {currentUserId ? getPersonNameById(currentUserId).split(' ')[0] : 'Kto ty?'}
                                </button>
                                <button onClick={() => setDarkMode(!darkMode)} className="bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center transition">
                                    {darkMode ? <Icons.Sun size={18} /> : <Icons.Moon size={18} />}
                                </button>
                                <button onClick={() => setIsSettingsOpen(true)} className="bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center transition">
                                    <Icons.Settings size={18} />
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 mt-6">
                        <div className="flex justify-center gap-4">
                            <button onClick={() => setActiveTab('family')} className={`flex-1 max-w-[160px] flex justify-center items-center gap-2 px-4 py-3 text-base font-medium transition-all rounded-xl ${activeTab === 'family' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-md ring-2 ring-amber-400' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800'}`}>
                                <Icons.Heart className={activeTab === 'family' ? 'text-red-500 fill-red-500' : ''} size={18} /> Rodzina
                            </button>
                            <button onClick={() => setActiveTab('friends')} className={`flex-1 max-w-[160px] flex justify-center items-center gap-2 px-4 py-3 text-base font-medium transition-all rounded-xl ${activeTab === 'friends' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-md ring-2 ring-blue-400' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800'}`}>
                                <Icons.Users className={activeTab === 'friends' ? 'text-blue-500 fill-blue-500' : ''} size={18} /> Znajomi
                            </button>
                        </div>
                    </div>

                    <main className="container mx-auto px-4 py-6">
                        {displayList.length === 0 ? (
                            <div className="text-center py-16 text-slate-400 dark:text-slate-600 bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 mx-4">
                                <p className="text-lg font-medium">Lista jest pusta.</p>
                                <p className="text-sm mt-2">Dodaj kogo≈õ u≈ºywajƒÖc zielonego przycisku!</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {displayList.map(person => (
                                    <div key={person.id} className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col relative group hover:shadow-md transition-shadow">
                                        <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${person.type === 'family' ? 'bg-amber-400' : 'bg-blue-400'}`}></div>
                                        
                                        {/* ZMODYFIKOWANE: Dodany Awatar i Flexbox */}
                                        <div className="p-5 pl-7 flex-grow flex gap-4">
                                            <div 
                                                className="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold text-lg shadow-sm"
                                                style={{ backgroundColor: stringToColor(person.name) }}
                                            >
                                                {getInitials(person.name)}
                                            </div>
                                            <div className="flex-grow">
                                                <div className="flex justify-between items-start mb-3">
                                                    <h3 className="text-lg font-bold text-slate-800 dark:text-slate-100 leading-tight flex items-center gap-2">
                                                        {person.name}
                                                        {(person.wishlist && person.wishlist.length > 0) && (
                                                            <Icons.Gift size={16} className="text-amber-500" />
                                                        )}
                                                    </h3>
                                                    {person.birthDate && (
                                                        <span className="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide">
                                                            {calculateAge(person.birthDate)} lat
                                                        </span>
                                                    )}
                                                    {Number.isFinite(person.__days) && (
                                                        <span className={`ml-2 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide ${person.__days === 0 ? 'bg-pink-500 text-white animate-pulse' : (person.__days <= 30 ? 'bg-amber-400 text-slate-900' : 'bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300')}`}>
                                                            {person.__days === 0 ? 'DZI≈ö!' : `Za ${person.__days} dni`}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="space-y-2 text-slate-600 dark:text-slate-400 text-sm">
                                                    <div className="flex items-center gap-3">
                                                        <Icons.Calendar size={16} className="text-slate-400" />
                                                        <span className={!person.birthDate ? 'text-red-400 text-xs font-medium' : ''}>
                                                            {person.birthDate ? new Date(person.birthDate).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' }) : 'BRAK DATY'}
                                                        </span>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <Icons.Phone size={16} className="text-slate-400" />
                                                        <a href={`tel:${person.phone}`} className="hover:text-blue-600 transition">
                                                            {person.phone || <span className="text-slate-300 text-xs dark:text-slate-500">Brak telefonu</span>}
                                                        </a>
                                                    </div>
                                                    {person.address && (
                                                        <div className="flex items-center gap-3">
                                                            <Icons.MapPin size={16} className="text-slate-400" />
                                                            <span className="text-slate-600 dark:text-slate-400 text-sm whitespace-pre-line">{person.address}</span>
                                                        </div>
                                                    )}
                                                    {person.notes && (
                                                        <div className="mt-3 bg-yellow-50/50 dark:bg-yellow-900/20 p-2 rounded text-xs text-slate-600 dark:text-slate-300 border-l-2 border-yellow-200 dark:border-yellow-600 italic">
                                                            {person.notes}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-slate-50 dark:bg-slate-700/50 p-3 pl-7 border-t border-slate-100 dark:border-slate-700 flex items-center gap-2">
                                            {/* ZMODYFIKOWANY: Przycisk otwierajƒÖcy Modal */}
                                            <button onClick={() => openCalendarModal(person)} className="flex-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400 text-slate-600 dark:text-slate-300 py-2 px-3 rounded-lg text-xs font-bold uppercase tracking-wide transition flex items-center justify-center gap-2 shadow-sm">
                                                <Icons.Calendar size={14} /> Kalendarz
                                            </button>
                                            <button onClick={() => { setSelectedPerson(person); setIsDetailsOpen(true); }} className="flex-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:border-amber-400 hover:text-amber-600 dark:hover:text-amber-400 text-slate-600 dark:text-slate-300 py-2 px-3 rounded-lg text-xs font-bold uppercase tracking-wide transition flex items-center justify-center gap-2 shadow-sm">
                                                <Icons.Gift size={14} /> Szczeg√≥≈Çy
                                            </button>
                                            <div className="flex gap-1">
                                                <button onClick={() => openModal(person)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-white dark:hover:bg-slate-600 rounded-lg transition"><Icons.Edit2 size={16} /></button>
                                                <button onClick={() => handleDelete(person.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-white dark:hover:bg-slate-600 rounded-lg transition"><Icons.Trash2 size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                    {isDetailsOpen && selectedPerson && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                                    <h3 className="text-base font-bold flex items-center gap-2 uppercase tracking-wide">
                                        Szczeg√≥≈Çy: {selectedPerson.name}
                                    </h3>
                                    <button onClick={() => { setIsDetailsOpen(false); setSelectedPerson(null); }} className="text-slate-400 hover:text-white transition"><Icons.X size={24} /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="space-y-2 text-slate-600 dark:text-slate-300 text-sm">
                                        <div className="flex items-center gap-3">
                                            <Icons.Calendar size={16} className="text-slate-400" />
                                            <span className={!selectedPerson.birthDate ? 'text-red-400 text-xs font-medium' : ''}>
                                                {selectedPerson.birthDate ? new Date(selectedPerson.birthDate).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' }) : 'BRAK DATY'}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <Icons.Phone size={16} className="text-slate-400" />
                                            <a href={`tel:${selectedPerson.phone}`} className="hover:text-blue-600 transition">
                                                {selectedPerson.phone || <span className="text-slate-300 text-xs">Brak telefonu</span>}
                                            </a>
                                        </div>
                                        {selectedPerson.address && (
                                            <div className="flex items-center gap-3">
                                                <Icons.MapPin size={16} className="text-slate-400" />
                                                <span className="text-slate-600 dark:text-slate-400 text-sm whitespace-pre-line">{selectedPerson.address}</span>
                                            </div>
                                        )}
                                        {selectedPerson.notes && (
                                            <div className="mt-3 bg-yellow-50/50 dark:bg-yellow-900/20 p-2 rounded text-xs text-slate-600 dark:text-slate-300 border-l-2 border-yellow-200 dark:border-yellow-600 italic">
                                                {selectedPerson.notes}
                                            </div>
                                        )}
                                    </div>
                                    <Wishlist person={selectedPerson} currentUserId={currentUserId} onUpdate={(p) => { setSelectedPerson(p); updatePerson(p); }} resolveName={getPersonNameById} />
                                </div>
                            </div>
                        </div>
                    )}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                                    <h3 className="text-base font-bold flex items-center gap-2 uppercase tracking-wide">
                                        {editingPerson ? 'Edycja Danych' : 'Dodaj Osobƒô'}
                                    </h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-white transition"><Icons.X size={24} /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Imiƒô i Nazwisko</label>
                                        <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-3 focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-amber-400 outline-none transition font-medium text-slate-800 dark:text-white" placeholder="np. Jan Kowalski" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Data urodzenia</label>
                                            <input type="date" value={formData.birthDate} onChange={e => setFormData({...formData, birthDate: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-3 focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-amber-400 outline-none text-slate-800 dark:text-white" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Grupa</label>
                                            <select value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-3 focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-amber-400 outline-none text-slate-800 dark:text-white">
                                                <option value="family">Rodzina</option>
                                                <option value="friends">Znajomi</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Telefon</label>
                                        <input type="tel" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-3 focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-amber-400 outline-none text-slate-800 dark:text-white" placeholder="np. 500 600 700" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Adres</label>
                                        <textarea value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-3 focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-amber-400 outline-none h-20 resize-none text-slate-800 dark:text-white" placeholder="np. ul. Kwiatowa 1\n00-000 Miasto" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Uwagi</label>
                                        <textarea value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-3 focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-amber-400 outline-none h-20 resize-none text-slate-800 dark:text-white" />
                                    </div>
                                    <button onClick={handleSave} className="w-full bg-amber-400 hover:bg-amber-500 text-slate-900 font-bold py-4 rounded-xl shadow-lg transition flex justify-center items-center gap-2 mt-4 uppercase tracking-wide text-sm">
                                        <Icons.Save size={18} /> Zapisz Zmiany
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {(!currentUserId || isUserPickerOpen) && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                                    <h3 className="text-base font-bold uppercase tracking-wide">{currentUserId ? 'Zmie≈Ñ u≈ºytkownika' : 'Witaj! Kto jeste≈õ?'}</h3>
                                    {currentUserId && (
                                        <button onClick={() => setIsUserPickerOpen(false)} className="text-slate-400 hover:text-white transition"><Icons.X size={24} /></button>
                                    )}
                                </div>
                                <div className="p-6 space-y-3">
                                    <p className="text-sm text-slate-600 dark:text-slate-300">Wybierz swojƒÖ osobƒô z listy:</p>
                                    <div className="max-h-80 overflow-auto space-y-2">
                                        {people.map(p => (
                                            <button key={p.id} onClick={() => { setCurrentUserId(p.id); setIsUserPickerOpen(false); }} className="w-full text-left bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 border border-slate-200 dark:border-slate-600 px-3 py-2 rounded-lg flex items-center justify-between">
                                                <span className="text-sm font-medium text-slate-800 dark:text-slate-200">{p.name}</span>
                                                <span className={`text-[10px] px-2 py-1 rounded-full uppercase ${p.type === 'family' ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-200' : 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-200'}`}>{p.type === 'family' ? 'Rodzina' : 'Znajomi'}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- DODANE: Modal Kalendarza --- */}
                    {isCalendarModalOpen && calendarPerson && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="bg-amber-500 text-white p-4 flex justify-between items-center">
                                    <h3 className="text-base font-bold flex items-center gap-2 uppercase tracking-wide">
                                        <Icons.Calendar size={18} /> Przypomnienie
                                    </h3>
                                    <button onClick={() => setIsCalendarModalOpen(false)} className="text-white/80 hover:text-white transition"><Icons.X size={24} /></button>
                                </div>
                                <div className="p-6 space-y-5">
                                    <div>
                                        <p className="text-sm text-slate-600 dark:text-slate-300">Dla kogo dodajemy przypomnienie?</p>
                                        <p className="text-lg font-bold mt-1 text-slate-900 dark:text-white">{calendarPerson.name}</p>
                                        <p className="text-xs text-slate-400 mt-0.5">
                                            Data urodzin: {new Date(calendarPerson.birthDate).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}
                                        </p>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Ile dni przed urodzinami?</label>
                                        <div className="flex items-center gap-3 bg-slate-50 dark:bg-slate-700 p-2 rounded-lg border border-slate-200 dark:border-slate-600">
                                            <button 
                                                onClick={() => setDaysBeforeBirthday(d => Math.max(1, d - 1))}
                                                className="w-10 h-10 flex items-center justify-center bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-500 font-bold text-slate-600 dark:text-slate-200"
                                            >-</button>
                                            <div className="flex-1 text-center">
                                                <span className="text-2xl font-bold text-slate-800 dark:text-white">{daysBeforeBirthday}</span>
                                                <span className="text-sm text-slate-500 dark:text-slate-400 ml-1">dni</span>
                                            </div>
                                            <button 
                                                onClick={() => setDaysBeforeBirthday(d => d + 1)}
                                                className="w-10 h-10 flex items-center justify-center bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-500 font-bold text-slate-600 dark:text-slate-200"
                                            >+</button>
                                        </div>
                                        <p className="text-xs text-center text-amber-600 dark:text-amber-400 mt-2 font-medium">
                                            Wydarzenie zostanie dodane: {(() => {
                                                const today = new Date();
                                                const bDate = new Date(calendarPerson.birthDate);
                                                let nextBday = new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate());
                                                if (nextBday < today) nextBday.setFullYear(today.getFullYear() + 1);
                                                const remDate = new Date(nextBday);
                                                remDate.setDate(nextBday.getDate() - daysBeforeBirthday);
                                                return remDate.toLocaleDateString('pl-PL');
                                            })()}
                                        </p>
                                    </div>

                                    <button 
                                        onClick={() => {
                                            const url = generateCalendarLink(calendarPerson, daysBeforeBirthday);
                                            window.open(url, '_blank');
                                            setIsCalendarModalOpen(false);
                                        }}
                                        className="w-full bg-amber-400 hover:bg-amber-500 text-slate-900 font-bold py-3 rounded-xl shadow-lg transition flex justify-center items-center gap-2 uppercase tracking-wide text-sm"
                                    >
                                        <Icons.Calendar size={18} /> Dodaj do Kalendarza
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- DODANE: Modal Ustawie≈Ñ --- */}
                    {isSettingsOpen && (
                         <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                                    <h3 className="text-base font-bold flex items-center gap-2 uppercase tracking-wide">
                                        <Icons.Settings size={18} /> Ustawienia
                                    </h3>
                                    <button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 hover:text-white transition"><Icons.X size={24} /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl">
                                        <div>
                                            <p className="font-bold text-slate-800 dark:text-white text-sm">Tryb Ciemny</p>
                                            <p className="text-xs text-slate-500">Zmienia wyglƒÖd aplikacji</p>
                                        </div>
                                        <button onClick={() => setDarkMode(!darkMode)} className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 ease-in-out ${darkMode ? 'bg-amber-500' : 'bg-slate-300'}`}>
                                            <div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform duration-300 ease-in-out ${darkMode ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                        </button>
                                    </div>
                                    
                                    <button onClick={handleExportData} className="w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-xl transition group">
                                        <div className="text-left">
                                            <p className="font-bold text-slate-800 dark:text-white text-sm">Kopia Zapasowa</p>
                                            <p className="text-xs text-slate-500">Pobierz dane (JSON)</p>
                                        </div>
                                        <Icons.Download className="text-slate-400 group-hover:text-amber-500 transition" size={20} />
                                    </button>
                                </div>
                            </div>
                         </div>
                    )}
                    
                    {/* --- DODANE: Toast Notification --- */}
                    {toast.visible && (
                        <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg z-[60] flex items-center gap-2 toast-animate font-bold text-sm uppercase tracking-wide ${toast.type === 'success' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'}`}>
                            {toast.type === 'success' ? <Icons.Check size={16} /> : <Icons.X size={16} />}
                            {toast.message}
                        </div>
                    )}

                    <footer className="text-slate-300 dark:text-slate-600 py-8 text-center text-xs opacity-50">
                        Wawrzak Board {new Date().getFullYear()}
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WawrzakBoard />);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => {
                regs.forEach(reg => reg.unregister());
            });
        }
    </script>
</body>
</html>
