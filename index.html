<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wawrzak Board</title>
    
    <!-- --- 1. PO≈ÅƒÑCZENIE Z PLIKIEM MANIFESTU --- -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Ustawienia dla iOS (iPhone) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wawrzak Board">
    <meta name="theme-color" content="#0f172a">
    <!-- Opcjonalnie: ikona dla iOS -->
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Biblioteki zewnƒôtrzne (Tailwind, React, Babel) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* Blokada "gumkowania" strony przy przewijaniu */
        body { 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
        }
        /* Ukrycie paska przewijania dla estetyki */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 select-none">
    <div id="root"></div>

    <!-- --- 2. KOD APLIKACJI --- -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- IKONY (SVG) ---
        const IconWrapper = ({ children, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick} style={{cursor: onClick ? 'pointer' : 'default'}}>
                {children}
            </svg>
        );

        const Icons = {
            PartyPopper: (props) => <IconWrapper {...props}><path d="M5.8 11.3 2 22l10.7-3.79"/><path d="M4 3h.01"/><path d="M22 8h.01"/><path d="M15 2h.01"/><path d="M22 20h.01"/><path d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12v0c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10"/><path d="m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11v0c-.11.7-.72 1.22-1.43 1.22H17"/><path d="m11 2 .33.82c.34.86-.2 1.82-1.11 1.98v0C9.52 4.9 9 5.52 9 6.23V7"/><path d="M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z"/></IconWrapper>,
            UserPlus: (props) => <IconWrapper {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></IconWrapper>,
            Heart: (props) => <IconWrapper {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconWrapper>,
            Users: (props) => <IconWrapper {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>,
            Calendar: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconWrapper>,
            Phone: (props) => <IconWrapper {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconWrapper>,
            Bell: (props) => <IconWrapper {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconWrapper>,
            Edit2: (props) => <IconWrapper {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>,
            Trash2: (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Save: (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            X: (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>
        };
        Icons.Gift = (props) => (
            <IconWrapper {...props}>
                <rect x="3" y="8" width="18" height="13" rx="2"/>
                <path d="M3 8h18"/>
                <path d="M12 8v13"/>
                <path d="M12 8c-1.66 0-3-1.79-3-3.5S10.34 1 12 1s3 1.79 3 3.5S13.66 8 12 8Z"/>
            </IconWrapper>
        );
        Icons.MapPin = (props) => (
            <IconWrapper {...props}>
                <path d="M12 21s8-4.5 8-11a8 8 0 1 0-16 0c0 6.5 8 11 8 11z"/>
                <circle cx="12" cy="10" r="3"/>
            </IconWrapper>
        );
        Icons.Check = (props) => (
            <IconWrapper {...props}>
                <polyline points="20 6 9 17 4 12"/>
            </IconWrapper>
        );
        Icons.EyeOff = (props) => (
            <IconWrapper {...props}>
                <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19.5C6.32 19.5 3 12.5 3 12.5a21.77 21.77 0 0 1 5.06-6.44"/>
                <path d="M1 1l22 22"/>
                <path d="M9.88 9.88a3 3 0 0 0 4.24 4.24"/>
                <path d="M12 5.5c5.68 0 9 7 9 7a21.77 21.77 0 0 1-3.2 4.02"/>
            </IconWrapper>
        );

        // --- DANE STARTOWE ---
        const INITIAL_FAMILY = [
            { id: 1,  name: 'Tomasz Wawrzak',     birthDate: '1965-03-02', phone: '', notes: '', type: 'family' },
            { id: 2,  name: 'Zdzis≈Çaw Koseski',   birthDate: '1955-03-15', phone: '', notes: '', type: 'family' },
            { id: 3,  name: 'El≈ºbieta Wawrzak',   birthDate: '1964-03-17', phone: '', notes: '', type: 'family' },
            { id: 4,  name: '≈Åukasz Wawrzak',     birthDate: '1987-09-23', phone: '', notes: '', type: 'family' },
            { id: 5,  name: 'Kinga Wawrzak',      birthDate: '1988-07-09', phone: '', notes: '', type: 'family' },
            { id: 6,  name: 'Kornelia Wawrzak',   birthDate: '2023-06-19', phone: '', notes: '', type: 'family' },
            { id: 7,  name: 'Micha≈Ç Wawrzak',     birthDate: '1994-06-10', phone: '', notes: '', type: 'family' },
            { id: 8,  name: 'Milena Wawrzak',     birthDate: '1993-06-20', phone: '', notes: '', type: 'family' },
            { id: 9,  name: 'Michalina Wawrzak',  birthDate: '2021-10-23', phone: '', notes: '', type: 'family' },
            { id: 10, name: 'Marcel Wawrzak',     birthDate: '2023-09-17', phone: '', notes: '', type: 'family' },
            { id: 11, name: 'Kamil Wawrzak',      birthDate: '1991-04-21', phone: '', notes: '', type: 'family' },
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyDqNfSnW90aBAvu98nJeqMgJbbWXwVwZf4",
            authDomain: "wawrzak-board.firebaseapp.com",
            projectId: "wawrzak-board",
            storageBucket: "wawrzak-board.firebasestorage.app",
            messagingSenderId: "504386767824",
            appId: "1:504386767824:web:63edc5a12503e9e5c907d5",
            measurementId: "G-78JL4DVGV4"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const DB = firebase.firestore();
        try { DB.enablePersistence(); } catch (e) {}

        const Fire = {
            db: DB,
            collection: (db, name) => db.collection(name),
            doc: (db, col, id) => db.collection(col).doc(String(id)),
            onSnapshot: (ref, cb) => ref.onSnapshot(cb),
            setDoc: (ref, data, options = {}) => options.merge ? ref.set(data, { merge: true }) : ref.set(data),
            deleteDoc: (ref) => ref.delete(),
        };

        const migratePeople = (list) => {
            return (list || []).map(p => ({
                ...p,
                address: typeof p.address === 'string' ? p.address : '',
                wishlist: Array.isArray(p.wishlist) ? p.wishlist.map(item => ({
                    id: item.id ?? Date.now() + Math.random(),
                    name: item.name ?? '',
                    reservedBy: typeof item.reservedBy === 'number' ? item.reservedBy : null,
                })) : [],
            }));
        };

        const syncWithSource = (loaded, source) => {
            const sourceMap = new Map(source.map(s => [s.name, s]));
            const NAME_CORRECTIONS = {
                'Zdzis≈Çaw Kosecki': 'Zdzis≈Çaw Koseski',
                'Zdzis≈Çawa Koseski': 'Zdzis≈Çaw Koseski',
                'Tomasz Pawe≈Ç Wawrzak': 'Tomasz Wawrzak'
            };

            const normalized = (loaded || []).map(p => ({ ...p, name: NAME_CORRECTIONS[p.name] || p.name }));

            const byName = new Map();
            normalized.forEach(p => {
                const ex = byName.get(p.name);
                if (!ex) {
                    byName.set(p.name, { ...p });
                } else {
                    const merged = { ...ex };
                    merged.phone = merged.phone || p.phone || '';
                    merged.notes = merged.notes || p.notes || '';
                    merged.address = merged.address || p.address || '';
                    const a = Array.isArray(merged.wishlist) ? merged.wishlist : [];
                    const b = Array.isArray(p.wishlist) ? p.wishlist : [];
                    const union = [...a];
                    b.forEach(item => { if (!union.some(x => x.id === item.id && x.name === item.name)) union.push(item); });
                    merged.wishlist = union;
                    byName.set(p.name, merged);
                }
            });

            let maxId = 0;
            byName.forEach(p => { if (typeof p.id === 'number' && p.id > maxId) maxId = p.id; });

            const updated = Array.from(byName.values()).map(p => {
                const s = sourceMap.get(p.name);
                const base = { ...p };
                if (s && base.type === 'family') {
                    base.birthDate = s.birthDate;
                    base.type = 'family';
                }
                return base;
            });

            const existingNames = new Set(updated.map(p => p.name));
            source.forEach(s => {
                if (!existingNames.has(s.name)) {
                    maxId += 1;
                    updated.push({
                        id: maxId,
                        name: s.name,
                        birthDate: s.birthDate,
                        phone: '',
                        notes: '',
                        address: '',
                        wishlist: [],
                        type: 'family',
                    });
                }
            });

            return migratePeople(updated);
        };

        function Wishlist({ person, currentUserId, onUpdate, resolveName }) {
            const [newItemName, setNewItemName] = useState('');

            const addItem = () => {
                const name = newItemName.trim();
                if (!name) return;
                const updated = {
                    ...person,
                    wishlist: [...(person.wishlist || []), { id: Date.now(), name, reservedBy: null }]
                };
                onUpdate(updated);
                setNewItemName('');
            };

            const deleteItem = (id) => {
                const updated = {
                    ...person,
                    wishlist: (person.wishlist || []).filter(w => w.id !== id)
                };
                onUpdate(updated);
            };

            const reserveItem = (id) => {
                const updated = {
                    ...person,
                    wishlist: (person.wishlist || []).map(w => w.id === id ? { ...w, reservedBy: currentUserId } : w)
                };
                onUpdate(updated);
            };

            const isSelf = currentUserId === person.id;

            return (
                <div className="space-y-3">
                    <div className="flex items-center gap-2">
                        <Icons.Gift className="text-amber-500" size={18} />
                        <h4 className="text-sm font-bold uppercase tracking-wide">Lista ≈ªycze≈Ñ</h4>
                    </div>
                    {isSelf ? (
                        <div className="space-y-3">
                            <div className="flex gap-2">
                                <input type="text" value={newItemName} onChange={e => setNewItemName(e.target.value)} className="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:bg-white focus:ring-2 focus:ring-amber-400 outline-none text-sm" placeholder="Dodaj ≈ºyczenie (np. ksiƒÖ≈ºka)" />
                                <button onClick={addItem} className="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide">Dodaj</button>
                            </div>
                            <ul className="space-y-2">
                                {(person.wishlist || []).length === 0 ? (
                                    <li className="text-xs text-slate-400">Brak element√≥w na li≈õcie.</li>
                                ) : (
                                    (person.wishlist || []).map(item => (
                                        <li key={item.id} className="flex items-center justify-between bg-slate-50 px-3 py-2 rounded-md border border-slate-200">
                                            <span className="text-sm">{item.name}</span>
                                            <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700 text-xs font-bold uppercase tracking-wide">Usu≈Ñ</button>
                                        </li>
                                    ))
                                )}
                            </ul>
                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                <Icons.EyeOff size={14} />
                                <span>Nie zobaczysz rezerwacji swoich ≈ºycze≈Ñ.</span>
                            </div>
                        </div>
                    ) : (
                        <ul className="space-y-2">
                            {(person.wishlist || []).length === 0 ? (
                                <li className="text-xs text-slate-400">Brak ≈ºycze≈Ñ do zarezerwowania.</li>
                            ) : (
                                (person.wishlist || []).map(item => (
                                    <li key={item.id} className="flex items-center justify-between bg-slate-50 px-3 py-2 rounded-md border border-slate-200">
                                        <span className={`text-sm ${item.reservedBy ? 'line-through text-slate-400' : ''}`}>{item.name}</span>
                                        {item.reservedBy ? (
                                            <div className="flex items-center gap-2 text-green-600 text-xs">
                                                <Icons.Check size={14} />
                                                <span>Zarezerwowane przez {resolveName(item.reservedBy)}</span>
                                            </div>
                                        ) : (
                                            <button onClick={() => reserveItem(item.id)} className="bg-amber-400 hover:bg-amber-500 text-slate-900 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wide">Rezerwuj</button>
                                        )}
                                    </li>
                                ))
                            )}
                        </ul>
                    )}
                </div>
            );
        }

        function WawrzakBoard() {
            const [people, setPeople] = useState([]);
            const [activeTab, setActiveTab] = useState('family');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingPerson, setEditingPerson] = useState(null);
            const [formData, setFormData] = useState({ name: '', birthDate: '', phone: '', address: '', notes: '', reminderDays: 3, type: 'family' });
            const [currentUserId, setCurrentUserId] = useState(() => {
                const saved = localStorage.getItem('wawrzakCurrentUserId');
                return saved ? Number(saved) : null;
            });
            const [isDetailsOpen, setIsDetailsOpen] = useState(false);
            const [selectedPerson, setSelectedPerson] = useState(null);
            const [isUserPickerOpen, setIsUserPickerOpen] = useState(false);

            useEffect(() => {
                if (!Fire) return;
                const colRef = Fire.collection(Fire.db, 'people');
                let initial = true;
                const unsub = Fire.onSnapshot(colRef, async (snapshot) => {
                    const loaded = snapshot.docs.map(d => {
                        const data = d.data();
                        const id = typeof data.id === 'number' ? data.id : Number(d.id);
                        return { ...data, id };
                    });
                    const synced = syncWithSource(loaded, INITIAL_FAMILY);
                    setPeople(synced);

                    const loadedById = new Map(loaded.map(p => [p.id, p]));
                    const syncedIds = new Set(synced.map(p => p.id));
                    const snapshotIds = new Set(snapshot.docs.map(d => {
                        const data = d.data();
                        return typeof data.id === 'number' ? data.id : Number(d.id);
                    }));

                    for (const p of synced) {
                        const lp = loadedById.get(p.id);
                        const needUpdate = !lp || lp.name !== p.name || lp.birthDate !== p.birthDate || lp.type !== p.type;
                        if (needUpdate) {
                            await Fire.setDoc(Fire.doc(Fire.db, 'people', String(p.id)), p, { merge: true });
                        }
                    }

                    for (const d of snapshot.docs) {
                        const data = d.data();
                        const id = typeof data.id === 'number' ? data.id : Number(d.id);
                        if (!syncedIds.has(id)) {
                            await Fire.deleteDoc(Fire.doc(Fire.db, 'people', d.id));
                        }
                    }

                    if (initial && snapshot.empty) {
                        for (const p of INITIAL_FAMILY) {
                            await Fire.setDoc(Fire.doc(Fire.db, 'people', String(p.id)), p);
                        }
                    }
                    initial = false;
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (currentUserId != null) {
                    localStorage.setItem('wawrzakCurrentUserId', String(currentUserId));
                }
            }, [currentUserId]);

            const getPersonNameById = (id) => {
                const p = people.find(x => x.id === id);
                return p ? p.name : 'Nieznany';
            };

            const updatePerson = (updatedPerson) => {
                if (!Fire) return;
                Fire.setDoc(Fire.doc(Fire.db, 'people', String(updatedPerson.id)), updatedPerson, { merge: true });
            };

            const openModal = (person = null) => {
                if (person) {
                    setEditingPerson(person);
                    setFormData({ name: person.name, birthDate: person.birthDate, phone: person.phone, address: person.address || '', notes: person.notes, reminderDays: 3, type: person.type });
                } else {
                    setEditingPerson(null);
                    setFormData({ name: '', birthDate: '', phone: '', address: '', notes: '', reminderDays: 3, type: activeTab });
                }
                setIsModalOpen(true);
            };

            const handleSave = async () => {
                if (!formData.name) return alert('Podaj imiƒô i nazwisko!');
                if (editingPerson) {
                    await Fire.setDoc(Fire.doc(Fire.db, 'people', String(editingPerson.id)), { ...editingPerson, ...formData }, { merge: true });
                } else {
                    const newPerson = { ...formData, id: Date.now(), address: formData.address || '', wishlist: [] };
                    await Fire.setDoc(Fire.doc(Fire.db, 'people', String(newPerson.id)), newPerson);
                }
                setIsModalOpen(false);
            };

            const handleDelete = async (id) => {
                if (window.confirm('Czy na pewno chcesz usunƒÖƒá tƒô osobƒô?')) {
                    await Fire.deleteDoc(Fire.doc(Fire.db, 'people', String(id)));
                }
            };

            const addToCalendar = (person) => {
                if (!person.birthDate) return alert('Uzupe≈Çnij datƒô urodzenia, aby ustawiƒá przypomnienie.');
                const birthDate = new Date(person.birthDate);
                const now = new Date();
                let nextBirthdayYear = now.getFullYear();
                const birthdayThisYear = new Date(now.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                if (birthdayThisYear < now) nextBirthdayYear += 1;

                const eventDate = `${nextBirthdayYear}${String(birthDate.getMonth() + 1).padStart(2, '0')}${String(birthDate.getDate()).padStart(2, '0')}`;
                const reminderTrigger = `-P${formData.reminderDays || 3}D`; 
                const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//WawrzakBoard//Bdays//PL\nBEGIN:VEVENT\nUID:${Date.now()}@wawrzakboard.com\nDTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\nDTSTART;VALUE=DATE:${eventDate}\nSUMMARY:üéÇ Urodziny: ${person.name}\nDESCRIPTION:Pamiƒôtaj o ≈ºyczeniach! Telefon: ${person.phone}. Uwagi: ${person.notes}\nRRULE:FREQ=YEARLY\nBEGIN:VALARM\nTRIGGER:${reminderTrigger}\nDESCRIPTION:Przypomnienie o urodzinach - Wawrzak Board\nACTION:DISPLAY\nEND:VALARM\nEND:VEVENT\nEND:VCALENDAR`;

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.setAttribute('download', `Urodziny_${person.name.replace(/\s+/g, '_')}.ics`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const calculateAge = (birthDate) => {
                if (!birthDate) return '';
                const diff = Date.now() - new Date(birthDate).getTime();
                return Math.abs(new Date(diff).getUTCFullYear() - 1970);
            };

            const displayList = people.filter(p => p.type === activeTab);

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
                    <header className="bg-gradient-to-b from-slate-900 to-slate-800 text-white shadow-xl rounded-b-3xl pt-8 pb-6 px-4 sticky top-0 z-10 select-none">
                        <div className="container mx-auto flex flex-col items-center text-center">
                            <div className="flex flex-col items-center gap-3 mb-6 transform transition hover:scale-105 duration-300">
                                <div className="bg-gradient-to-br from-amber-300 to-amber-500 p-3 rounded-2xl shadow-lg shadow-amber-500/20">
                                    <Icons.PartyPopper className="w-10 h-10 text-slate-900" />
                                </div>
                                <div>
                                    <h1 className="text-3xl md:text-4xl font-bold tracking-wide font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-amber-500">Wawrzak Board</h1>
                                    <p className="text-slate-400 text-xs uppercase tracking-widest mt-1 font-medium">Centrum ZarzƒÖdzania RodzinƒÖ</p>
                                </div>
                            </div>
                            <button onClick={() => openModal()} className="bg-emerald-500 hover:bg-emerald-600 active:scale-95 text-white px-8 py-3 rounded-full shadow-lg shadow-emerald-500/30 transition-all flex items-center gap-2 font-bold text-sm uppercase tracking-wide">
                                <Icons.UserPlus size={20} /> Dodaj Osobƒô
                            </button>
                            <div className="mt-3">
                                <button onClick={() => setIsUserPickerOpen(true)} className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                                    <Icons.Users size={16} /> {currentUserId ? `U≈ºytkownik: ${getPersonNameById(currentUserId)}` : 'Wybierz u≈ºytkownika'}
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 mt-6">
                        <div className="flex justify-center gap-4">
                            <button onClick={() => setActiveTab('family')} className={`flex-1 max-w-[160px] flex justify-center items-center gap-2 px-4 py-3 text-base font-medium transition-all rounded-xl ${activeTab === 'family' ? 'bg-white text-slate-900 shadow-md ring-2 ring-amber-400' : 'text-slate-500 hover:bg-white/50'}`}>
                                <Icons.Heart className={activeTab === 'family' ? 'text-red-500 fill-red-500' : ''} size={18} /> Rodzina
                            </button>
                            <button onClick={() => setActiveTab('friends')} className={`flex-1 max-w-[160px] flex justify-center items-center gap-2 px-4 py-3 text-base font-medium transition-all rounded-xl ${activeTab === 'friends' ? 'bg-white text-slate-900 shadow-md ring-2 ring-blue-400' : 'text-slate-500 hover:bg-white/50'}`}>
                                <Icons.Users className={activeTab === 'friends' ? 'text-blue-500 fill-blue-500' : ''} size={18} /> Znajomi
                            </button>
                        </div>
                    </div>

                    <main className="container mx-auto px-4 py-6">
                        {displayList.length === 0 ? (
                            <div className="text-center py-16 text-slate-400 bg-white rounded-3xl shadow-sm border border-slate-100 mx-4">
                                <p className="text-lg font-medium">Lista jest pusta.</p>
                                <p className="text-sm mt-2">Dodaj kogo≈õ u≈ºywajƒÖc zielonego przycisku!</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {displayList.map(person => (
                                    <div key={person.id} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col relative group hover:shadow-md transition-shadow">
                                        <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${person.type === 'family' ? 'bg-amber-400' : 'bg-blue-400'}`}></div>
                                        <div className="p-5 pl-7 flex-grow">
                                            <div className="flex justify-between items-start mb-3">
                                                <h3 className="text-lg font-bold text-slate-800 leading-tight flex items-center gap-2">
                                                    {person.name}
                                                    {(person.wishlist && person.wishlist.length > 0) && (
                                                        <Icons.Gift size={16} className="text-amber-500" />
                                                    )}
                                                </h3>
                                                {person.birthDate && (
                                                    <span className="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide">
                                                        {calculateAge(person.birthDate)} lat
                                                    </span>
                                                )}
                                            </div>
                                            <div className="space-y-2 text-slate-600 text-sm">
                                                <div className="flex items-center gap-3">
                                                    <Icons.Calendar size={16} className="text-slate-400" />
                                                    <span className={!person.birthDate ? 'text-red-400 text-xs font-medium' : ''}>
                                                        {person.birthDate ? new Date(person.birthDate).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' }) : 'BRAK DATY'}
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <Icons.Phone size={16} className="text-slate-400" />
                                                    <a href={`tel:${person.phone}`} className="hover:text-blue-600 transition">
                                                        {person.phone || <span className="text-slate-300 text-xs">Brak telefonu</span>}
                                                    </a>
                                                </div>
                                                {person.address && (
                                                    <div className="flex items-center gap-3">
                                                        <Icons.MapPin size={16} className="text-slate-400" />
                                                        <span className="text-slate-600 text-sm whitespace-pre-line">{person.address}</span>
                                                    </div>
                                                )}
                                                {person.notes && (
                                                    <div className="mt-3 bg-yellow-50/50 p-2 rounded text-xs text-slate-600 border-l-2 border-yellow-200 italic">
                                                        {person.notes}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="bg-slate-50/50 p-3 pl-7 border-t border-slate-100 flex items-center gap-2">
                                            <button onClick={() => addToCalendar(person)} className="flex-1 bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 text-slate-600 py-2 px-3 rounded-lg text-xs font-bold uppercase tracking-wide transition flex items-center justify-center gap-2 shadow-sm">
                                                <Icons.Bell size={14} /> Przypomnij
                                            </button>
                                            <button onClick={() => { setSelectedPerson(person); setIsDetailsOpen(true); }} className="flex-1 bg-white border border-slate-200 hover:border-amber-400 hover:text-amber-600 text-slate-600 py-2 px-3 rounded-lg text-xs font-bold uppercase tracking-wide transition flex items-center justify-center gap-2 shadow-sm">
                                                <Icons.Gift size={14} /> Szczeg√≥≈Çy
                                            </button>
                                            <div className="flex gap-1">
                                                <button onClick={() => openModal(person)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-white rounded-lg transition"><Icons.Edit2 size={16} /></button>
                                                <button onClick={() => handleDelete(person.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-white rounded-lg transition"><Icons.Trash2 size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                    {isDetailsOpen && selectedPerson && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                                    <h3 className="text-base font-bold flex items-center gap-2 uppercase tracking-wide">
                                        Szczeg√≥≈Çy: {selectedPerson.name}
                                    </h3>
                                    <button onClick={() => { setIsDetailsOpen(false); setSelectedPerson(null); }} className="text-slate-400 hover:text-white transition"><Icons.X size={24} /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="space-y-2 text-slate-600 text-sm">
                                        <div className="flex items-center gap-3">
                                            <Icons.Calendar size={16} className="text-slate-400" />
                                            <span className={!selectedPerson.birthDate ? 'text-red-400 text-xs font-medium' : ''}>
                                                {selectedPerson.birthDate ? new Date(selectedPerson.birthDate).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' }) : 'BRAK DATY'}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <Icons.Phone size={16} className="text-slate-400" />
                                            <a href={`tel:${selectedPerson.phone}`} className="hover:text-blue-600 transition">
                                                {selectedPerson.phone || <span className="text-slate-300 text-xs">Brak telefonu</span>}
                                            </a>
                                        </div>
                                        {selectedPerson.address && (
                                            <div className="flex items-center gap-3">
                                                <Icons.MapPin size={16} className="text-slate-400" />
                                                <span className="text-slate-600 text-sm whitespace-pre-line">{selectedPerson.address}</span>
                                            </div>
                                        )}
                                        {selectedPerson.notes && (
                                            <div className="mt-3 bg-yellow-50/50 p-2 rounded text-xs text-slate-600 border-l-2 border-yellow-200 italic">
                                                {selectedPerson.notes}
                                            </div>
                                        )}
                                    </div>
                                    <Wishlist person={selectedPerson} currentUserId={currentUserId} onUpdate={(p) => { setSelectedPerson(p); updatePerson(p); }} resolveName={getPersonNameById} />
                                </div>
                            </div>
                        </div>
                    )}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                                    <h3 className="text-base font-bold flex items-center gap-2 uppercase tracking-wide">
                                        {editingPerson ? 'Edycja Danych' : 'Dodaj Osobƒô'}
                                    </h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-white transition"><Icons.X size={24} /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Imiƒô i Nazwisko</label>
                                        <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-3 focus:bg-white focus:ring-2 focus:ring-amber-400 outline-none transition font-medium" placeholder="np. Jan Kowalski" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Data urodzenia</label>
                                            <input type="date" value={formData.birthDate} onChange={e => setFormData({...formData, birthDate: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-3 focus:bg-white focus:ring-2 focus:ring-amber-400 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Grupa</label>
                                            <select value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-3 focus:bg-white focus:ring-2 focus:ring-amber-400 outline-none">
                                                <option value="family">Rodzina</option>
                                                <option value="friends">Znajomi</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Telefon</label>
                                        <input type="tel" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-3 focus:bg-white focus:ring-2 focus:ring-amber-400 outline-none" placeholder="np. 500 600 700" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Adres</label>
                                        <textarea value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-3 focus:bg-white focus:ring-2 focus:ring-amber-400 outline-none h-20 resize-none" placeholder="np. ul. Kwiatowa 1\n00-000 Miasto" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Uwagi</label>
                                        <textarea value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-3 focus:bg-white focus:ring-2 focus:ring-amber-400 outline-none h-20 resize-none" />
                                    </div>
                                    <button onClick={handleSave} className="w-full bg-amber-400 hover:bg-amber-500 text-slate-900 font-bold py-4 rounded-xl shadow-lg transition flex justify-center items-center gap-2 mt-4 uppercase tracking-wide text-sm">
                                        <Icons.Save size={18} /> Zapisz Zmiany
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {(!currentUserId || isUserPickerOpen) && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                                    <h3 className="text-base font-bold uppercase tracking-wide">{currentUserId ? 'Zmie≈Ñ u≈ºytkownika' : 'Witaj! Kto jeste≈õ?'}</h3>
                                    {currentUserId && (
                                        <button onClick={() => setIsUserPickerOpen(false)} className="text-slate-400 hover:text-white transition"><Icons.X size={24} /></button>
                                    )}
                                </div>
                                <div className="p-6 space-y-3">
                                    <p className="text-sm text-slate-600">Wybierz swojƒÖ osobƒô z listy:</p>
                                    <div className="max-h-80 overflow-auto space-y-2">
                                        {people.map(p => (
                                            <button key={p.id} onClick={() => { setCurrentUserId(p.id); setIsUserPickerOpen(false); }} className="w-full text-left bg-slate-50 hover:bg-slate-100 border border-slate-200 px-3 py-2 rounded-lg flex items-center justify-between">
                                                <span className="text-sm font-medium">{p.name}</span>
                                                <span className={`text-[10px] px-2 py-1 rounded-full uppercase ${p.type === 'family' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`}>{p.type === 'family' ? 'Rodzina' : 'Znajomi'}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    <footer className="text-slate-300 py-8 text-center text-xs opacity-50">
                        Wawrzak Board {new Date().getFullYear()}
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WawrzakBoard />);

        // --- 3. REJESTRACJA SERVICE WORKER (SW.JS) ---
        // To m√≥wi przeglƒÖdarce: "Hej, tutaj jest plik sw.js, u≈ºyj go!"
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker OK', reg))
                    .catch(err => console.log('B≈ÇƒÖd SW', err));
            });
        }
    </script>
</body>
</html>
